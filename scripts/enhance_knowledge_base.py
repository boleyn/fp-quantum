"""
é‡å­æ™ºèƒ½åŒ–åŠŸèƒ½ç‚¹ä¼°ç®—ç³»ç»Ÿ - çŸ¥è¯†åº“å¢å¼ºè„šæœ¬

æ·»åŠ NESMAå’ŒCOSMICæ ‡å‡†æ–‡æ¡£ï¼Œå®Œå–„çŸ¥è¯†åº“å†…å®¹
"""

import asyncio
import json
from pathlib import Path
from typing import Dict, List, Any, Optional
import logging
from datetime import datetime

from langchain_community.document_loaders import TextLoader, JSONLoader
from langchain_text_splitters import RecursiveCharacterTextSplitter
from langchain_openai import OpenAIEmbeddings
from langchain_chroma import Chroma

from knowledge_base.embeddings.embedding_models import get_embedding_model
from knowledge_base.vector_stores.mongodb_atlas import setup_mongodb_vector

logger = logging.getLogger(__name__)


class KnowledgeBaseEnhancer:
    """çŸ¥è¯†åº“å¢å¼ºå™¨"""
    
    def __init__(self):
        self.embeddings = get_embedding_model("bge_m3")
        self.text_splitter = RecursiveCharacterTextSplitter(
            chunk_size=800,
            chunk_overlap=150,
            separators=["\n\n", "\n", "ã€‚", ".", "!", "?", "ï¼›", ";"]
        )
        
    async def create_nesma_knowledge_documents(self) -> List[Dict[str, Any]]:
        """åˆ›å»ºNESMAçŸ¥è¯†æ–‡æ¡£"""
        
        nesma_documents = [
            {
                "title": "NESMAåŠŸèƒ½ç±»å‹åˆ†ç±»è§„åˆ™",
                "content": """
                NESMA v2.3+ åŠŸèƒ½ç±»å‹åˆ†ç±»è¯¦ç»†è§„åˆ™
                
                ## å†…éƒ¨é€»è¾‘æ–‡ä»¶ (ILF - Internal Logical File)
                
                **å®šä¹‰**: ç”±åº”ç”¨ç¨‹åºç»´æŠ¤çš„ç”¨æˆ·å¯è¯†åˆ«çš„é€»è¾‘ç›¸å…³æ•°æ®ç»„
                
                **è¯†åˆ«è§„åˆ™**:
                1. æ•°æ®å¿…é¡»ç”±è¯¥åº”ç”¨ç¨‹åºç»´æŠ¤ï¼ˆå¢åˆ æ”¹ï¼‰
                2. æ•°æ®å¿…é¡»å¯¹ç”¨æˆ·æœ‰æ„ä¹‰
                3. æ•°æ®å¿…é¡»æ„æˆé€»è¾‘ç›¸å…³çš„ç»„
                4. å¿…é¡»é€šè¿‡åº”ç”¨ç¨‹åºè¾¹ç•Œçš„ä¸€ä¸ªæˆ–å¤šä¸ªåŸºæœ¬è¿‡ç¨‹è¿›è¡Œç»´æŠ¤
                
                **å¸¸è§ç¤ºä¾‹**:
                - å®¢æˆ·ä¸»æ•°æ®æ–‡ä»¶
                - äº§å“ç›®å½•
                - è®¢å•è®°å½•
                - ç”¨æˆ·è´¦æˆ·ä¿¡æ¯
                
                **æ’é™¤æ¡ä»¶**:
                - çº¯æŠ€æœ¯æ–‡ä»¶ï¼ˆå¦‚æ—¥å¿—ã€é…ç½®æ–‡ä»¶ï¼‰
                - ä¸´æ—¶å·¥ä½œæ–‡ä»¶
                - ç”±å…¶ä»–åº”ç”¨ç»´æŠ¤çš„æ–‡ä»¶
                
                ## å¤–éƒ¨æ¥å£æ–‡ä»¶ (EIF - External Interface File)
                
                **å®šä¹‰**: ç”±å…¶ä»–åº”ç”¨ç¨‹åºç»´æŠ¤ï¼Œä½†è¢«ä¼°ç®—åº”ç”¨ç¨‹åºå¼•ç”¨çš„é€»è¾‘ç›¸å…³æ•°æ®ç»„
                
                **è¯†åˆ«è§„åˆ™**:
                1. æ•°æ®ç”±å…¶ä»–åº”ç”¨ç¨‹åºç»´æŠ¤
                2. æ•°æ®è¢«ä¼°ç®—åº”ç”¨ç¨‹åºå¼•ç”¨æˆ–ä½¿ç”¨
                3. æ•°æ®å¯¹ç”¨æˆ·æœ‰æ„ä¹‰
                4. æ•°æ®æ„æˆé€»è¾‘ç›¸å…³çš„ç»„
                
                **å¸¸è§ç¤ºä¾‹**:
                - å¤–éƒ¨ç³»ç»Ÿçš„å®¢æˆ·æ•°æ®
                - ç¬¬ä¸‰æ–¹äº§å“ç›®å½•
                - å…±äº«çš„ä»£ç è¡¨
                - å¤–éƒ¨æ±‡ç‡æ•°æ®
                
                **é‡è¦åŒºåˆ«**: EIFä¸è¢«è¯¥åº”ç”¨ç¨‹åºç»´æŠ¤ï¼Œåªèƒ½è¯»å–æˆ–å¼•ç”¨
                
                ## å¤–éƒ¨è¾“å…¥ (EI - External Input)
                
                **å®šä¹‰**: ä»åº”ç”¨ç¨‹åºè¾¹ç•Œå¤–éƒ¨è¿›å…¥ï¼Œç”¨äºç»´æŠ¤ä¸€ä¸ªæˆ–å¤šä¸ªILFå’Œ/æˆ–æ”¹å˜ç³»ç»Ÿè¡Œä¸ºçš„åŸºæœ¬è¿‡ç¨‹
                
                **è¯†åˆ«è§„åˆ™**:
                1. æ•°æ®æˆ–æ§åˆ¶ä¿¡æ¯æ¥è‡ªåº”ç”¨ç¨‹åºè¾¹ç•Œå¤–éƒ¨
                2. è¿‡ç¨‹æ›´æ–°ä¸€ä¸ªæˆ–å¤šä¸ªILF
                3. æˆ–æ”¹å˜åº”ç”¨ç¨‹åºçš„è¡Œä¸º
                4. å…·æœ‰å”¯ä¸€çš„å¤„ç†é€»è¾‘
                
                **å¸¸è§ç¤ºä¾‹**:
                - ç”¨æˆ·æ³¨å†Œ
                - æ•°æ®å½•å…¥å±å¹•
                - æ‰¹é‡æ•°æ®å¯¼å…¥
                - ç³»ç»Ÿé…ç½®æ›´æ–°
                
                **å¤„ç†è§„åˆ™**:
                - ç›¸åŒæ•°æ®é€šè¿‡ä¸åŒç•Œé¢è¾“å…¥ = å¤šä¸ªEI
                - æ‰¹é‡å’Œåœ¨çº¿è¾“å…¥åŒä¸€æ•°æ® = 2ä¸ªEI
                
                ## å¤–éƒ¨è¾“å‡º (EO - External Output)
                
                **å®šä¹‰**: å‘åº”ç”¨ç¨‹åºè¾¹ç•Œå¤–éƒ¨å‘é€æ•°æ®æˆ–æ§åˆ¶ä¿¡æ¯çš„åŸºæœ¬è¿‡ç¨‹ï¼ŒåŒ…å«é¢å¤–å¤„ç†é€»è¾‘
                
                **è¯†åˆ«è§„åˆ™**:
                1. æ•°æ®æˆ–ä¿¡æ¯å‘é€åˆ°åº”ç”¨ç¨‹åºè¾¹ç•Œå¤–éƒ¨
                2. åŒ…å«æ•°å­¦è®¡ç®—ã€å¯¼å‡ºæ•°æ®æˆ–åˆ›å»ºé¢å¤–ä¿¡æ¯
                3. æˆ–æ”¹å˜åº”ç”¨ç¨‹åºè¡Œä¸º
                4. å…·æœ‰å”¯ä¸€çš„å¤„ç†é€»è¾‘
                
                **å¸¸è§ç¤ºä¾‹**:
                - åŒ…å«è®¡ç®—çš„æŠ¥è¡¨
                - æ•°æ®å¯¼å‡ºåŠŸèƒ½
                - ä»ªè¡¨æ¿ï¼ˆå¸¦è®¡ç®—ï¼‰
                - ç»Ÿè®¡åˆ†ææŠ¥å‘Š
                
                **é‡è¦ç‰¹å¾**: å¿…é¡»åŒ…å«æ´¾ç”Ÿæ•°æ®æˆ–é¢å¤–å¤„ç†é€»è¾‘
                
                ## å¤–éƒ¨æŸ¥è¯¢ (EQ - External Inquiry)
                
                **å®šä¹‰**: å‘åº”ç”¨ç¨‹åºè¾¹ç•Œå¤–éƒ¨å‘é€æ•°æ®æˆ–æ§åˆ¶ä¿¡æ¯çš„åŸºæœ¬è¿‡ç¨‹ï¼Œä»…åŒ…å«æ£€ç´¢é€»è¾‘
                
                **è¯†åˆ«è§„åˆ™**:
                1. æ•°æ®å‘é€åˆ°åº”ç”¨ç¨‹åºè¾¹ç•Œå¤–éƒ¨
                2. ä»…åŒ…å«æ£€ç´¢å’Œæ˜¾ç¤ºé€»è¾‘
                3. ä¸åŒ…å«æ•°å­¦è®¡ç®—æˆ–æ´¾ç”Ÿæ•°æ®
                4. ä¸æ›´æ–°ILF
                
                **å¸¸è§ç¤ºä¾‹**:
                - ç®€å•æŸ¥è¯¢å±å¹•
                - æ•°æ®åˆ—è¡¨æ˜¾ç¤º
                - è®°å½•è¯¦æƒ…æŸ¥çœ‹
                - åŸºæœ¬æœç´¢åŠŸèƒ½
                
                **EO vs EQåŒºåˆ«**:
                - EO: åŒ…å«è®¡ç®—ã€æ´¾ç”Ÿæˆ–å¤æ‚å¤„ç†
                - EQ: ä»…æ£€ç´¢å’Œæ˜¾ç¤ºåŸå§‹æ•°æ®
                
                ## åˆ†ç±»å†³ç­–æ ‘
                
                1. æ˜¯å¦ä¸ºæ•°æ®æ–‡ä»¶ï¼Ÿ
                   - æ˜¯ â†’ 2
                   - å¦ â†’ 5
                
                2. æ•°æ®ç”±æœ¬åº”ç”¨ç»´æŠ¤ï¼Ÿ
                   - æ˜¯ â†’ ILF
                   - å¦ â†’ 3
                
                3. æ•°æ®è¢«æœ¬åº”ç”¨å¼•ç”¨ï¼Ÿ
                   - æ˜¯ â†’ EIF
                   - å¦ â†’ ä¸è®¡ç®—
                
                4. æ˜¯å¦ä¸ºäº‹åŠ¡å¤„ç†ï¼Ÿ
                   - æ˜¯ â†’ 5
                   - å¦ â†’ ä¸è®¡ç®—
                
                5. æ˜¯å¦æ›´æ–°æ•°æ®æˆ–æ”¹å˜è¡Œä¸ºï¼Ÿ
                   - æ˜¯ â†’ EI
                   - å¦ â†’ 6
                
                6. æ˜¯å¦åŒ…å«è®¡ç®—æˆ–æ´¾ç”Ÿæ•°æ®ï¼Ÿ
                   - æ˜¯ â†’ EO
                   - å¦ â†’ EQ
                """
            },
            {
                "title": "NESMAå¤æ‚åº¦è®¡ç®—æ–¹æ³•",
                "content": """
                NESMAå¤æ‚åº¦è®¡ç®—è¯¦ç»†æ–¹æ³•
                
                ## æ•°æ®å…ƒç´ ç±»å‹ (DET - Data Element Type)
                
                **å®šä¹‰**: ç”¨æˆ·å¯è¯†åˆ«çš„ã€ä¸å¯é‡å¤çš„å­—æ®µ
                
                **è®¡ç®—è§„åˆ™**:
                1. æ¯ä¸ªå”¯ä¸€çš„ç”¨æˆ·å¯è¯†åˆ«å­—æ®µ = 1 DET
                2. é‡å¤å­—æ®µåªè®¡ç®—ä¸€æ¬¡
                3. æŠ€æœ¯å­—æ®µä¸è®¡ç®—ï¼ˆå¦‚IDã€æ—¶é—´æˆ³ï¼‰
                4. æ“ä½œæŒ‰é’®/å‘½ä»¤æ¯ä¸ªåŠŸèƒ½è®¡1 DET
                
                **ILF/EIFçš„DETè®¡ç®—**:
                - åŒ…å«è¯¥æ–‡ä»¶ä¸­æ‰€æœ‰ç”¨æˆ·å¯è¯†åˆ«å­—æ®µ
                - å¤–é”®å¼•ç”¨è®¡1 DET
                - é‡å¤ç»„ä¸­çš„å­—æ®µæŒ‰å”¯ä¸€ç±»å‹è®¡ç®—
                
                **EIçš„DETè®¡ç®—**:
                - è¾“å…¥å­—æ®µæ•°é‡
                - æ–‡ä»¶æ“ä½œå‘½ä»¤ï¼ˆå¢ã€åˆ ã€æ”¹å„1ä¸ªï¼‰
                - ä¸åŒ…æ‹¬ç³»ç»Ÿç”Ÿæˆå­—æ®µ
                
                **EO/EQçš„DETè®¡ç®—**:
                - è¾“å‡ºå­—æ®µæ•°é‡
                - è¾“å…¥å‚æ•°å­—æ®µæ•°é‡
                - æŸ¥è¯¢æ¡ä»¶å­—æ®µæ•°é‡
                
                ## è®°å½•å…ƒç´ ç±»å‹ (RET - Record Element Type)
                
                **å®šä¹‰**: é€»è¾‘ç›¸å…³çš„æ•°æ®å…ƒç´ å­ç»„
                
                **è®¡ç®—è§„åˆ™**:
                1. ä¸»è®°å½•ç±»å‹ = 1 RET
                2. æ¯ä¸ªé‡å¤å­ç»„ = 1 RET
                3. æ¯ä¸ªä¸åŒçš„è®°å½•æ ¼å¼ = 1 RET
                
                **ILF/EIFçš„RETè®¡ç®—**:
                - ä¸»è®°å½• = 1 RET
                - æ¯ä¸ªé‡å¤ç»„ = 1 RET
                - æ¯ä¸ªå­å®ä½“ç±»å‹ = 1 RET
                
                **EIçš„RETè®¡ç®—**:
                - æ¯ä¸ªè¢«ç»´æŠ¤çš„ILF = 1 RET
                - ä¸åŒçš„è¾“å…¥è®°å½•æ ¼å¼å„è®¡1 RET
                
                **EO/EQçš„RETè®¡ç®—**:
                - æ¯ä¸ªè¢«å¼•ç”¨çš„ILF/EIF = 1 RET
                - ä¸åŒçš„è¾“å‡ºè®°å½•æ ¼å¼å„è®¡1 RET
                
                ## å¤æ‚åº¦ç­‰çº§çŸ©é˜µ
                
                ### ILFå¤æ‚åº¦çŸ©é˜µ
                | DETèŒƒå›´ | 1-19 DET | 20-50 DET | 51+ DET |
                |---------|----------|-----------|---------|
                | 1 RET   | Low      | Low       | Average |
                | 2-5 RET | Low      | Average   | High    |
                | 6+ RET  | Average  | High      | High    |
                
                ### EIFå¤æ‚åº¦çŸ©é˜µ
                | DETèŒƒå›´ | 1-19 DET | 20-50 DET | 51+ DET |
                |---------|----------|-----------|---------|
                | 1 RET   | Low      | Low       | Average |
                | 2-5 RET | Low      | Average   | High    |
                | 6+ RET  | Average  | High      | High    |
                
                ### EIå¤æ‚åº¦çŸ©é˜µ
                | DETèŒƒå›´ | 1-14 DET | 15-19 DET | 20+ DET |
                |---------|----------|-----------|---------|
                | 1 RET   | Low      | Low       | Average |
                | 2 RET   | Low      | Average   | High    |
                | 3+ RET  | Average  | High      | High    |
                
                ### EOå¤æ‚åº¦çŸ©é˜µ
                | DETèŒƒå›´ | 1-19 DET | 20-50 DET | 51+ DET |
                |---------|----------|-----------|---------|
                | 1 RET   | Low      | Low       | Average |
                | 2-3 RET | Low      | Average   | High    |
                | 4+ RET  | Average  | High      | High    |
                
                ### EQå¤æ‚åº¦çŸ©é˜µ
                | DETèŒƒå›´ | 1-19 DET | 20-50 DET | 51+ DET |
                |---------|----------|-----------|---------|
                | 1 RET   | Low      | Low       | Average |
                | 2-3 RET | Low      | Average   | High    |
                | 4+ RET  | Average  | High      | High    |
                
                ## è®¡ç®—ç¤ºä¾‹
                
                **ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½ï¼ˆEIï¼‰**:
                - DET: å§“åã€é‚®ç®±ã€å¯†ç ã€ç¡®è®¤å¯†ç ã€æ‰‹æœºå· = 5 DET
                - RET: æ›´æ–°ç”¨æˆ·è¡¨ = 1 RET
                - å¤æ‚åº¦: 5 DET + 1 RET = Low
                
                **é”€å”®æŠ¥è¡¨åŠŸèƒ½ï¼ˆEOï¼‰**:
                - DET: äº§å“åã€é”€é‡ã€é‡‘é¢ã€æ—¥æœŸã€å®¢æˆ·æ•° = 5 DET
                - RET: è®¢å•è¡¨ã€äº§å“è¡¨ = 2 RET
                - å¤æ‚åº¦: 5 DET + 2 RET = Low
                
                **å®¢æˆ·ä¿¡æ¯æ–‡ä»¶ï¼ˆILFï¼‰**:
                - DET: å®¢æˆ·å·ã€å§“åã€åœ°å€ã€ç”µè¯ã€é‚®ç®±ç­‰ = 15 DET
                - RET: ä¸»è®°å½• = 1 RET
                - å¤æ‚åº¦: 15 DET + 1 RET = Low
                """
            },
            {
                "title": "NESMAæƒé‡è¡¨å’ŒUFPè®¡ç®—",
                "content": """
                NESMAæƒé‡è¡¨å’Œæœªè°ƒæ•´åŠŸèƒ½ç‚¹è®¡ç®—
                
                ## æ ‡å‡†æƒé‡è¡¨
                
                ### æ•°æ®åŠŸèƒ½æƒé‡
                | åŠŸèƒ½ç±»å‹ | Low | Average | High |
                |---------|-----|---------|------|
                | ILF     | 7   | 10      | 15   |
                | EIF     | 5   | 7       | 10   |
                
                ### äº‹åŠ¡åŠŸèƒ½æƒé‡
                | åŠŸèƒ½ç±»å‹ | Low | Average | High |
                |---------|-----|---------|------|
                | EI      | 3   | 4       | 6    |
                | EO      | 4   | 5       | 7    |
                | EQ      | 3   | 4       | 6    |
                
                ## UFPè®¡ç®—å…¬å¼
                
                UFP = Î£(åŠŸèƒ½ç±»å‹æ•°é‡ Ã— å¯¹åº”æƒé‡)
                
                **è¯¦ç»†è®¡ç®—**:
                - ILF_UFP = (ILF_Low Ã— 7) + (ILF_Average Ã— 10) + (ILF_High Ã— 15)
                - EIF_UFP = (EIF_Low Ã— 5) + (EIF_Average Ã— 7) + (EIF_High Ã— 10)
                - EI_UFP = (EI_Low Ã— 3) + (EI_Average Ã— 4) + (EI_High Ã— 6)
                - EO_UFP = (EO_Low Ã— 4) + (EO_Average Ã— 5) + (EO_High Ã— 7)
                - EQ_UFP = (EQ_Low Ã— 3) + (EQ_Average Ã— 4) + (EQ_High Ã— 6)
                
                æ€»UFP = ILF_UFP + EIF_UFP + EI_UFP + EO_UFP + EQ_UFP
                
                ## è®¡ç®—ç¤ºä¾‹
                
                **ç”µå•†ç³»ç»Ÿä¼°ç®—**:
                
                ### æ•°æ®åŠŸèƒ½
                - ILF: å®¢æˆ·æ–‡ä»¶(Low,7)ã€äº§å“æ–‡ä»¶(Average,10)ã€è®¢å•æ–‡ä»¶(High,15)
                - EIF: å¤–éƒ¨æ”¯ä»˜ç³»ç»Ÿ(Low,5)ã€ç‰©æµæ¥å£(Average,7)
                
                ### äº‹åŠ¡åŠŸèƒ½
                - EI: ç”¨æˆ·æ³¨å†Œ(Low,3)ã€ä¸‹å•(Average,4)ã€æ”¯ä»˜(High,6)
                - EO: é”€å”®æŠ¥è¡¨(Average,5)ã€å‘ç¥¨ç”Ÿæˆ(High,7)
                - EQ: äº§å“æŸ¥è¯¢(Low,3)ã€è®¢å•æŸ¥è¯¢(Average,4)
                
                ### UFPè®¡ç®—
                - æ•°æ®åŠŸèƒ½: (7+10+15) + (5+7) = 32 + 12 = 44 UFP
                - äº‹åŠ¡åŠŸèƒ½: (3+4+6) + (5+7) + (3+4) = 13 + 12 + 7 = 32 UFP
                - æ€»è®¡: 44 + 32 = 76 UFP
                
                ## è´¨é‡æ£€æŸ¥
                
                **åˆç†æ€§æ£€æŸ¥**:
                1. æ•°æ®åŠŸèƒ½å æ¯”é€šå¸¸åœ¨30-70%
                2. äº‹åŠ¡åŠŸèƒ½å æ¯”é€šå¸¸åœ¨30-70%
                3. å¹³å‡å¤æ‚åº¦åˆ†å¸ƒåº”åˆç†
                
                **å¸¸è§é”™è¯¯**:
                1. é—æ¼æ•°æ®æ–‡ä»¶
                2. é‡å¤è®¡ç®—åŠŸèƒ½
                3. å¤æ‚åº¦è¯„ä¼°åå·®
                4. è¾¹ç•Œè¯†åˆ«é”™è¯¯
                
                **æœ€ä½³å®è·µ**:
                1. è¯¦ç»†è®°å½•æ¯ä¸ªåŠŸèƒ½çš„è¯†åˆ«ä¾æ®
                2. è¿›è¡Œå¤šè½®è¯„å®¡
                3. å¯¹æ¯”åŒç±»é¡¹ç›®
                4. è®°å½•å‡è®¾å’Œæ’é™¤é¡¹
                """
            }
        ]
        
        return nesma_documents
    
    async def create_cosmic_knowledge_documents(self) -> List[Dict[str, Any]]:
        """åˆ›å»ºCOSMICçŸ¥è¯†æ–‡æ¡£"""
        
        cosmic_documents = [
            {
                "title": "COSMICåŸºæœ¬æ¦‚å¿µå’ŒåŸåˆ™",
                "content": """
                COSMIC v4.0+ åŸºæœ¬æ¦‚å¿µå’Œæµ‹é‡åŸåˆ™
                
                ## æ ¸å¿ƒæ¦‚å¿µ
                
                ### åŠŸèƒ½ç”¨æˆ· (Functional User)
                **å®šä¹‰**: å‘é€æ•°æ®åˆ°è½¯ä»¶æˆ–ä»è½¯ä»¶æ¥æ”¶æ•°æ®çš„ç”¨æˆ·ç±»å‹
                
                **ç‰¹å¾**:
                - å¯ä»¥æ˜¯äººç±»ç”¨æˆ·ã€è®¾å¤‡ã€å…¶ä»–è½¯ä»¶
                - é€šè¿‡è½¯ä»¶è¾¹ç•Œä¸è½¯ä»¶äº¤äº’
                - å…·æœ‰ç‰¹å®šçš„åŠŸèƒ½éœ€æ±‚
                
                **è¯†åˆ«è§„åˆ™**:
                1. å¿…é¡»æ˜¯æ•°æ®çš„å‘é€è€…æˆ–æ¥æ”¶è€…
                2. å¿…é¡»ä½äºè½¯ä»¶è¾¹ç•Œä¹‹å¤–
                3. å¿…é¡»æœ‰æ˜ç¡®çš„åŠŸèƒ½ç›®çš„
                
                **å¸¸è§ç±»å‹**:
                - æœ€ç»ˆç”¨æˆ·ï¼šç›´æ¥ä½¿ç”¨è½¯ä»¶çš„äºº
                - ç³»ç»Ÿç®¡ç†å‘˜ï¼šé…ç½®å’Œç»´æŠ¤è½¯ä»¶çš„äºº
                - å¤–éƒ¨ç³»ç»Ÿï¼šä¸è½¯ä»¶äº¤äº’çš„å…¶ä»–è½¯ä»¶
                - è®¾å¤‡ï¼šä¼ æ„Ÿå™¨ã€æ‰“å°æœºç­‰ç¡¬ä»¶è®¾å¤‡
                
                ### è½¯ä»¶è¾¹ç•Œ (Software Boundary)
                **å®šä¹‰**: åŒºåˆ†è¢«æµ‹é‡è½¯ä»¶ä¸å…¶ç¯å¢ƒçš„æ¦‚å¿µç•Œé™
                
                **ç¡®å®šåŸåˆ™**:
                1. åŸºäºç”¨æˆ·è§†è§’å®šä¹‰
                2. åŒ…å«æ‰€æœ‰è¢«æµ‹é‡çš„åŠŸèƒ½
                3. æ’é™¤ä¸å±äºæµ‹é‡èŒƒå›´çš„ç»„ä»¶
                
                **è¾¹ç•Œå†…å®¹**:
                - åº”ç”¨ç¨‹åºä»£ç 
                - é…ç½®æ•°æ®
                - ä¸šåŠ¡è§„åˆ™
                - ç”¨æˆ·ç•Œé¢é€»è¾‘
                
                **è¾¹ç•Œå¤–å†…å®¹**:
                - åŠŸèƒ½ç”¨æˆ·
                - æŒä¹…å­˜å‚¨
                - æ“ä½œç³»ç»Ÿ
                - ä¸­é—´ä»¶ï¼ˆé€šå¸¸ï¼‰
                
                ### æŒä¹…å­˜å‚¨ (Persistent Storage)
                **å®šä¹‰**: è½¯ä»¶è¾¹ç•Œå¤–çš„æ•°æ®å­˜å‚¨ï¼Œåœ¨è½¯ä»¶æ‰§è¡Œé—´ä¿æŒæ•°æ®
                
                **ç‰¹å¾**:
                - ç‹¬ç«‹äºè½¯ä»¶ç”Ÿå‘½å‘¨æœŸ
                - å¯è¢«å¤šä¸ªè½¯ä»¶è®¿é—®
                - åŒ…å«ç»“æ„åŒ–æ•°æ®
                
                **å¸¸è§å½¢å¼**:
                - æ•°æ®åº“
                - æ–‡ä»¶ç³»ç»Ÿ
                - é…ç½®æ–‡ä»¶
                - ç¼“å­˜ç³»ç»Ÿ
                
                ## æµ‹é‡åŸåˆ™
                
                ### åŠŸèƒ½è¿‡ç¨‹ (Functional Process)
                **å®šä¹‰**: ç”±å”¯ä¸€çš„åŠŸèƒ½ç”¨æˆ·è§¦å‘çš„æœ€å°åŠŸèƒ½å•å…ƒ
                
                **è¯†åˆ«è§„åˆ™**:
                1. ç”±ä¸€ä¸ªåŠŸèƒ½ç”¨æˆ·è§¦å‘
                2. åŒ…å«æœ‰æ„ä¹‰çš„ç»“æœ
                3. æ˜¯è‡ªåŒ…å«çš„åŠŸèƒ½å•å…ƒ
                4. èƒ½ç‹¬ç«‹æ‰§è¡Œ
                
                **ç»„æˆéƒ¨åˆ†**:
                - è§¦å‘äº‹ä»¶
                - å¤„ç†é€»è¾‘
                - æ•°æ®ç§»åŠ¨
                - è¾“å‡ºç»“æœ
                
                ### æ•°æ®ç»„ (Data Group)
                **å®šä¹‰**: åœ¨åŠŸèƒ½è¿‡ç¨‹ä¸­ä½œä¸ºæ•´ä½“ç§»åŠ¨çš„ç›¸å…³æ•°æ®å±æ€§é›†åˆ
                
                **è¯†åˆ«è§„åˆ™**:
                1. é€»è¾‘ç›¸å…³çš„æ•°æ®å±æ€§
                2. åœ¨åŠŸèƒ½è¿‡ç¨‹ä¸­ä¸€èµ·ç§»åŠ¨
                3. å¯¹åŠŸèƒ½ç”¨æˆ·æœ‰æ„ä¹‰
                
                **ç²’åº¦åŸåˆ™**:
                - æœ€å°æœ‰æ„ä¹‰çš„æ•°æ®é›†åˆ
                - é¿å…è¿‡äºç»†ç²’åº¦
                - é¿å…è¿‡äºç²—ç²’åº¦
                
                ## æ•°æ®ç§»åŠ¨ç±»å‹
                
                ### Entry (è¾“å…¥)
                **å®šä¹‰**: æ•°æ®ç»„ä»åŠŸèƒ½ç”¨æˆ·ç§»åŠ¨åˆ°è¢«æµ‹é‡è½¯ä»¶å†…éƒ¨
                
                **ç‰¹å¾**:
                - èµ·ç‚¹ï¼šåŠŸèƒ½ç”¨æˆ·
                - ç»ˆç‚¹ï¼šè½¯ä»¶å†…éƒ¨
                - ç›®çš„ï¼šæä¾›æ•°æ®ç»™è½¯ä»¶å¤„ç†
                
                **å¸¸è§åœºæ™¯**:
                - ç”¨æˆ·è¾“å…¥è¡¨å•æ•°æ®
                - å¤–éƒ¨ç³»ç»Ÿå‘é€æ•°æ®
                - æ–‡ä»¶ä¸Šä¼ 
                - APIè°ƒç”¨å‚æ•°
                
                ### Exit (è¾“å‡º)
                **å®šä¹‰**: æ•°æ®ç»„ä»è¢«æµ‹é‡è½¯ä»¶å†…éƒ¨ç§»åŠ¨åˆ°åŠŸèƒ½ç”¨æˆ·
                
                **ç‰¹å¾**:
                - èµ·ç‚¹ï¼šè½¯ä»¶å†…éƒ¨
                - ç»ˆç‚¹ï¼šåŠŸèƒ½ç”¨æˆ·
                - ç›®çš„ï¼šå‘åŠŸèƒ½ç”¨æˆ·æä¾›ä¿¡æ¯
                
                **å¸¸è§åœºæ™¯**:
                - æ˜¾ç¤ºæŸ¥è¯¢ç»“æœ
                - ç”ŸæˆæŠ¥è¡¨
                - å‘é€é€šçŸ¥
                - APIè¿”å›æ•°æ®
                
                ### Read (è¯»å–)
                **å®šä¹‰**: æ•°æ®ç»„ä»æŒä¹…å­˜å‚¨ç§»åŠ¨åˆ°è¢«æµ‹é‡è½¯ä»¶å†…éƒ¨
                
                **ç‰¹å¾**:
                - èµ·ç‚¹ï¼šæŒä¹…å­˜å‚¨
                - ç»ˆç‚¹ï¼šè½¯ä»¶å†…éƒ¨
                - ç›®çš„ï¼šè·å–å¤„ç†æ‰€éœ€æ•°æ®
                
                **å¸¸è§åœºæ™¯**:
                - æŸ¥è¯¢æ•°æ®åº“
                - è¯»å–é…ç½®æ–‡ä»¶
                - åŠ è½½ç”¨æˆ·ä¿¡æ¯
                - è®¿é—®ç¼“å­˜æ•°æ®
                
                ### Write (å†™å…¥)
                **å®šä¹‰**: æ•°æ®ç»„ä»è¢«æµ‹é‡è½¯ä»¶å†…éƒ¨ç§»åŠ¨åˆ°æŒä¹…å­˜å‚¨
                
                **ç‰¹å¾**:
                - èµ·ç‚¹ï¼šè½¯ä»¶å†…éƒ¨
                - ç»ˆç‚¹ï¼šæŒä¹…å­˜å‚¨
                - ç›®çš„ï¼šä¿å­˜æˆ–æ›´æ–°æ•°æ®
                
                **å¸¸è§åœºæ™¯**:
                - ä¿å­˜ç”¨æˆ·è¾“å…¥
                - æ›´æ–°è®°å½•çŠ¶æ€
                - å†™å…¥æ—¥å¿—
                - ç¼“å­˜è®¡ç®—ç»“æœ
                
                ## æµ‹é‡è§„åˆ™
                
                ### CFPè®¡ç®—å…¬å¼
                CFP = Entryæ•°é‡ + Exitæ•°é‡ + Readæ•°é‡ + Writeæ•°é‡
                
                **åŸºæœ¬åŸåˆ™**:
                - 1ä¸ªæ•°æ®ç§»åŠ¨ = 1 CFP
                - æ‰€æœ‰æ•°æ®ç§»åŠ¨ç­‰æƒé‡
                - æŒ‰åŠŸèƒ½è¿‡ç¨‹åˆ†ç»„è®¡ç®—
                
                ### è¾¹ç•Œä¸€è‡´æ€§
                **è½¯ä»¶è¾¹ç•Œä¸€è‡´æ€§**:
                - Entry/Exitå¿…é¡»ç©¿è¶Šè½¯ä»¶è¾¹ç•Œ
                - è¾¹ç•Œå†…çš„æ•°æ®ä¼ é€’ä¸è®¡ç®—
                
                **å­˜å‚¨è¾¹ç•Œä¸€è‡´æ€§**:
                - Read/Writeå¿…é¡»ç©¿è¶Šå­˜å‚¨è¾¹ç•Œ
                - è½¯ä»¶å†…éƒ¨æ•°æ®æ“ä½œä¸è®¡ç®—
                
                ### èšåˆçº§åˆ«
                **åŠŸèƒ½è¿‡ç¨‹çº§åˆ«**:
                - æŒ‰å•ä¸ªåŠŸèƒ½è¿‡ç¨‹è¯†åˆ«æ•°æ®ç§»åŠ¨
                - ç¡®ä¿å®Œæ•´æ€§å’Œä¸€è‡´æ€§
                
                **åº”ç”¨ç¨‹åºçº§åˆ«**:
                - æ±‡æ€»æ‰€æœ‰åŠŸèƒ½è¿‡ç¨‹çš„CFP
                - é¿å…é‡å¤è®¡ç®—
                """
            },
            {
                "title": "COSMICæ•°æ®ç§»åŠ¨è¯†åˆ«æŒ‡å—",
                "content": """
                COSMICæ•°æ®ç§»åŠ¨è¯†åˆ«è¯¦ç»†æŒ‡å—
                
                ## è¯†åˆ«æ­¥éª¤
                
                ### æ­¥éª¤1ï¼šè¯†åˆ«åŠŸèƒ½è¿‡ç¨‹
                **æ–¹æ³•**:
                1. åˆ†æç”¨æˆ·éœ€æ±‚
                2. è¯†åˆ«è§¦å‘äº‹ä»¶
                3. ç¡®å®šå¤„ç†è¾¹ç•Œ
                4. éªŒè¯åŠŸèƒ½å®Œæ•´æ€§
                
                **ç¤ºä¾‹ - ç”¨æˆ·ç™»å½•è¿‡ç¨‹**:
                - è§¦å‘è€…ï¼šç”¨æˆ·
                - è¾“å…¥ï¼šç”¨æˆ·åã€å¯†ç 
                - å¤„ç†ï¼šéªŒè¯å‡­æ®
                - è¾“å‡ºï¼šç™»å½•ç»“æœ
                
                ### æ­¥éª¤2ï¼šè¯†åˆ«æ•°æ®ç»„
                **åŸåˆ™**:
                1. é€»è¾‘ç›¸å…³æ€§
                2. ç§»åŠ¨ä¸€è‡´æ€§
                3. ç”¨æˆ·å¯è¯†åˆ«æ€§
                
                **ç²’åº¦æ§åˆ¶**:
                - è¿‡ç»†ï¼šæ¯ä¸ªå­—æ®µå•ç‹¬æˆç»„
                - é€‚ä¸­ï¼šç›¸å…³å­—æ®µç»„åˆ
                - è¿‡ç²—ï¼šæ•´ä¸ªè®°å½•ä½œä¸ºä¸€ç»„
                
                ### æ­¥éª¤3ï¼šè·Ÿè¸ªæ•°æ®ç§»åŠ¨
                **ç³»ç»ŸåŒ–æ–¹æ³•**:
                1. ç»˜åˆ¶æ•°æ®æµå›¾
                2. æ ‡è¯†è¾¹ç•Œç©¿è¶Šç‚¹
                3. åˆ†ç±»ç§»åŠ¨ç±»å‹
                4. éªŒè¯ç§»åŠ¨å¿…è¦æ€§
                
                ## Entryè¯†åˆ«è¯¦è§£
                
                ### å…¸å‹Entryåœºæ™¯
                **ç”¨æˆ·ç•Œé¢è¾“å…¥**:
                - è¡¨å•æäº¤ï¼šç”¨æˆ·å¡«å†™çš„è¡¨å•æ•°æ®
                - æ–‡ä»¶ä¸Šä¼ ï¼šç”¨æˆ·é€‰æ‹©çš„æ–‡ä»¶å†…å®¹
                - é€‰æ‹©æ“ä½œï¼šä¸‹æ‹‰é€‰æ‹©ã€å¤é€‰æ¡†çŠ¶æ€
                
                **ç³»ç»Ÿæ¥å£è¾“å…¥**:
                - APIè°ƒç”¨ï¼šå¤–éƒ¨ç³»ç»Ÿä¼ å…¥çš„å‚æ•°
                - æ¶ˆæ¯é˜Ÿåˆ—ï¼šæ¥æ”¶çš„æ¶ˆæ¯å†…å®¹
                - æ–‡ä»¶å¯¼å…¥ï¼šæ‰¹é‡å¯¼å…¥çš„æ•°æ®
                
                **è®¾å¤‡è¾“å…¥**:
                - ä¼ æ„Ÿå™¨æ•°æ®ï¼šæ¸©åº¦ã€å‹åŠ›ç­‰æµ‹é‡å€¼
                - æ‰«æè®¾å¤‡ï¼šæ¡ç ã€äºŒç»´ç å†…å®¹
                - GPSè®¾å¤‡ï¼šä½ç½®åæ ‡ä¿¡æ¯
                
                ### Entryè¯†åˆ«è§„åˆ™
                1. **è¾¹ç•Œç©¿è¶ŠéªŒè¯**
                   - æ•°æ®å¿…é¡»ä»å¤–éƒ¨è¿›å…¥è½¯ä»¶
                   - ä¸åŒ…æ‹¬è½¯ä»¶å†…éƒ¨çš„æ•°æ®ä¼ é€’
                
                2. **åŠŸèƒ½ç”¨æˆ·éªŒè¯**
                   - å¿…é¡»æ¥è‡ªå·²è¯†åˆ«çš„åŠŸèƒ½ç”¨æˆ·
                   - éªŒè¯ç”¨æˆ·çš„åˆæ³•æ€§
                
                3. **æ•°æ®ç»„å®Œæ•´æ€§**
                   - ç¡®ä¿æ•°æ®ç»„çš„é€»è¾‘å®Œæ•´æ€§
                   - é¿å…æ‹†åˆ†ç›¸å…³æ•°æ®
                
                ## Exitè¯†åˆ«è¯¦è§£
                
                ### å…¸å‹Exitåœºæ™¯
                **ç”¨æˆ·ç•Œé¢è¾“å‡º**:
                - æŸ¥è¯¢ç»“æœï¼šæ˜¾ç¤ºçš„æ•°æ®åˆ—è¡¨
                - æŠ¥è¡¨ç”Ÿæˆï¼šæ ¼å¼åŒ–çš„æŠ¥å‘Šå†…å®¹
                - çŠ¶æ€ä¿¡æ¯ï¼šæ“ä½œç»“æœæç¤º
                
                **ç³»ç»Ÿæ¥å£è¾“å‡º**:
                - APIå“åº”ï¼šè¿”å›ç»™è°ƒç”¨è€…çš„æ•°æ®
                - æ¶ˆæ¯å‘é€ï¼šå‘å¸ƒåˆ°æ¶ˆæ¯é˜Ÿåˆ—çš„å†…å®¹
                - æ–‡ä»¶å¯¼å‡ºï¼šç”Ÿæˆçš„ä¸‹è½½æ–‡ä»¶
                
                **è®¾å¤‡è¾“å‡º**:
                - æ‰“å°å†…å®¹ï¼šå‘é€åˆ°æ‰“å°æœºçš„æ•°æ®
                - æ˜¾ç¤ºå±ï¼šæ¨é€åˆ°æ˜¾ç¤ºè®¾å¤‡çš„ä¿¡æ¯
                - æ§åˆ¶æŒ‡ä»¤ï¼šå‘é€ç»™æ‰§è¡Œè®¾å¤‡çš„å‘½ä»¤
                
                ### Exitç‰¹æ®Šæƒ…å†µ
                **ç¡®è®¤æ¶ˆæ¯**:
                - æ“ä½œæˆåŠŸç¡®è®¤ = 1 Exit
                - é”™è¯¯æ¶ˆæ¯ = 1 Exit
                - ç®€å•çŠ¶æ€ç ä¸å•ç‹¬è®¡ç®—
                
                **åˆ†é¡µè¾“å‡º**:
                - æ¯é¡µç›¸åŒå†…å®¹ = 1 Exit
                - ä¸åŒé¡µé¢å†…å®¹ = å¤šä¸ªExit
                
                ## Readè¯†åˆ«è¯¦è§£
                
                ### å…¸å‹Readåœºæ™¯
                **æ•°æ®åº“æŸ¥è¯¢**:
                - å•è¡¨æŸ¥è¯¢ï¼šè¯»å–ç‰¹å®šè¡¨çš„è®°å½•
                - å¤šè¡¨å…³è”ï¼šè¯»å–å…³è”çš„æ•°æ®ç»„
                - é…ç½®æŸ¥è¯¢ï¼šè¯»å–ç³»ç»Ÿé…ç½®ä¿¡æ¯
                
                **æ–‡ä»¶è¯»å–**:
                - é…ç½®æ–‡ä»¶ï¼šè¯»å–åº”ç”¨é…ç½®
                - æ•°æ®æ–‡ä»¶ï¼šè¯»å–ä¸šåŠ¡æ•°æ®
                - æ¨¡æ¿æ–‡ä»¶ï¼šè¯»å–æŠ¥è¡¨æ¨¡æ¿
                
                **ç¼“å­˜è®¿é—®**:
                - å†…å­˜ç¼“å­˜ï¼šè¯»å–ç¼“å­˜çš„æ•°æ®
                - åˆ†å¸ƒå¼ç¼“å­˜ï¼šè¯»å–å…±äº«ç¼“å­˜
                - ä¼šè¯æ•°æ®ï¼šè¯»å–ç”¨æˆ·ä¼šè¯ä¿¡æ¯
                
                ### Readè®¡ç®—è§„åˆ™
                **ç›¸åŒæ•°æ®å¤šæ¬¡è¯»å–**:
                - åŒä¸€åŠŸèƒ½è¿‡ç¨‹ä¸­ = 1 Read
                - ä¸åŒåŠŸèƒ½è¿‡ç¨‹ä¸­ = åˆ†åˆ«è®¡ç®—
                
                **ä¸åŒç›®çš„è¯»å–**:
                - éªŒè¯ç”¨é€”ï¼šè¯»å–ç”¨äºéªŒè¯çš„æ•°æ®
                - æ˜¾ç¤ºç”¨é€”ï¼šè¯»å–ç”¨äºæ˜¾ç¤ºçš„æ•°æ®
                - å¤„ç†ç”¨é€”ï¼šè¯»å–ç”¨äºä¸šåŠ¡å¤„ç†çš„æ•°æ®
                
                ## Writeè¯†åˆ«è¯¦è§£
                
                ### å…¸å‹Writeåœºæ™¯
                **æ•°æ®åº“æ“ä½œ**:
                - æ’å…¥è®°å½•ï¼šåˆ›å»ºæ–°çš„æ•°æ®è®°å½•
                - æ›´æ–°è®°å½•ï¼šä¿®æ”¹ç°æœ‰æ•°æ®
                - åˆ é™¤è®°å½•ï¼šåˆ é™¤æ•°æ®è®°å½•
                
                **æ–‡ä»¶æ“ä½œ**:
                - åˆ›å»ºæ–‡ä»¶ï¼šç”Ÿæˆæ–°æ–‡ä»¶
                - æ›´æ–°æ–‡ä»¶ï¼šä¿®æ”¹æ–‡ä»¶å†…å®¹
                - æ—¥å¿—å†™å…¥ï¼šè®°å½•æ“ä½œæ—¥å¿—
                
                **ç¼“å­˜æ“ä½œ**:
                - ç¼“å­˜æ›´æ–°ï¼šæ›´æ–°ç¼“å­˜æ•°æ®
                - ä¼šè¯ä¿å­˜ï¼šä¿å­˜ä¼šè¯çŠ¶æ€
                - ä¸´æ—¶å­˜å‚¨ï¼šä¿å­˜ä¸´æ—¶æ•°æ®
                
                ### Writeç‰¹æ®Šæƒ…å†µ
                **æ‰¹é‡æ“ä½œ**:
                - æ‰¹é‡æ’å…¥ç›¸åŒç»“æ„ = 1 Write
                - æ‰¹é‡æ›´æ–°ä¸åŒè®°å½• = 1 Write
                - æ‰¹é‡æ“ä½œä¸åŒæ•°æ®ç»„ = å¤šä¸ªWrite
                
                **äº‹åŠ¡æ“ä½œ**:
                - äº‹åŠ¡å†…å¤šä¸ªWrite = åˆ†åˆ«è®¡ç®—
                - åŸå­æ“ä½œä½œä¸ºæ•´ä½“ = æŒ‰æ•°æ®ç»„è®¡ç®—
                
                ## è¾¹ç•ŒéªŒè¯æ£€æŸ¥è¡¨
                
                ### EntryéªŒè¯
                - [ ] æ•°æ®æ¥æºæ˜¯åŠŸèƒ½ç”¨æˆ·ï¼Ÿ
                - [ ] æ•°æ®ç©¿è¶Šè½¯ä»¶è¾¹ç•Œï¼Ÿ
                - [ ] æ•°æ®ç»„é€»è¾‘å®Œæ•´ï¼Ÿ
                - [ ] é¿å…é‡å¤è®¡ç®—ï¼Ÿ
                
                ### ExitéªŒè¯
                - [ ] æ•°æ®ç›®æ ‡æ˜¯åŠŸèƒ½ç”¨æˆ·ï¼Ÿ
                - [ ] æ•°æ®ç©¿è¶Šè½¯ä»¶è¾¹ç•Œï¼Ÿ
                - [ ] è¾“å‡ºå†…å®¹æœ‰æ„ä¹‰ï¼Ÿ
                - [ ] ç¡®è®¤æ¶ˆæ¯å·²è€ƒè™‘ï¼Ÿ
                
                ### ReadéªŒè¯
                - [ ] æ•°æ®æ¥æºæ˜¯æŒä¹…å­˜å‚¨ï¼Ÿ
                - [ ] è¯»å–æ˜¯åŠŸèƒ½å¿…éœ€çš„ï¼Ÿ
                - [ ] é¿å…é‡å¤è¯»å–è®¡ç®—ï¼Ÿ
                - [ ] æ•°æ®ç»„ç²’åº¦é€‚å½“ï¼Ÿ
                
                ### WriteéªŒè¯
                - [ ] æ•°æ®ç›®æ ‡æ˜¯æŒä¹…å­˜å‚¨ï¼Ÿ
                - [ ] å†™å…¥æ˜¯åŠŸèƒ½å¿…éœ€çš„ï¼Ÿ
                - [ ] æ“ä½œç±»å‹è¯†åˆ«æ­£ç¡®ï¼Ÿ
                - [ ] æ‰¹é‡æ“ä½œå¤„ç†æ°å½“ï¼Ÿ
                """
            }
        ]
        
        return cosmic_documents
    
    async def create_comparison_documents(self) -> List[Dict[str, Any]]:
        """åˆ›å»ºNESMAä¸COSMICå¯¹æ¯”æ–‡æ¡£"""
        
        comparison_documents = [
            {
                "title": "NESMA vs COSMIC å¯¹æ¯”åˆ†æ",
                "content": """
                NESMAä¸COSMICæ ‡å‡†å¯¹æ¯”åˆ†æ
                
                ## åŸºæœ¬ç†å¿µå¯¹æ¯”
                
                ### NESMAç†å¿µ
                **æ•°æ®å¯¼å‘**: ä»¥æ•°æ®æ–‡ä»¶å’Œäº‹åŠ¡ä¸ºæ ¸å¿ƒ
                **å¤æ‚åº¦åˆ†çº§**: é€šè¿‡DET/RETè®¡ç®—å¤æ‚åº¦ç­‰çº§
                **æƒé‡ç³»ç»Ÿ**: ä¸åŒå¤æ‚åº¦å¯¹åº”ä¸åŒæƒé‡
                **æˆç†Ÿåº¦**: å‘å±•å†å²æ‚ ä¹…ï¼Œåº”ç”¨å¹¿æ³›
                
                ### COSMICç†å¿µ
                **è¿‡ç¨‹å¯¼å‘**: ä»¥åŠŸèƒ½è¿‡ç¨‹å’Œæ•°æ®ç§»åŠ¨ä¸ºæ ¸å¿ƒ
                **ç­‰æƒé‡**: æ‰€æœ‰æ•°æ®ç§»åŠ¨ç­‰æƒé‡(1 CFP)
                **è¾¹ç•Œæ¸…æ™°**: æ˜ç¡®çš„è½¯ä»¶è¾¹ç•Œå’Œå­˜å‚¨è¾¹ç•Œ
                **ç°ä»£åŒ–**: é€‚åº”ç°ä»£è½¯ä»¶æ¶æ„
                
                ## æµ‹é‡å¯¹è±¡å¯¹æ¯”
                
                ### NESMAæµ‹é‡å¯¹è±¡
                | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
                |------|------|------|
                | ILF | å†…éƒ¨é€»è¾‘æ–‡ä»¶ | å®¢æˆ·æ¡£æ¡ˆã€äº§å“ç›®å½• |
                | EIF | å¤–éƒ¨æ¥å£æ–‡ä»¶ | å¤–éƒ¨ç³»ç»Ÿæ•°æ® |
                | EI | å¤–éƒ¨è¾“å…¥ | æ•°æ®å½•å…¥ã€æ›´æ–°æ“ä½œ |
                | EO | å¤–éƒ¨è¾“å‡º | è®¡ç®—æŠ¥è¡¨ã€ç»Ÿè®¡åˆ†æ |
                | EQ | å¤–éƒ¨æŸ¥è¯¢ | ç®€å•æŸ¥è¯¢ã€æ•°æ®æ˜¾ç¤º |
                
                ### COSMICæµ‹é‡å¯¹è±¡
                | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
                |------|------|------|
                | Entry | æ•°æ®è¾“å…¥ | ç”¨æˆ·è¾“å…¥ã€æ¥å£è°ƒç”¨ |
                | Exit | æ•°æ®è¾“å‡º | ç»“æœæ˜¾ç¤ºã€æ•°æ®è¿”å› |
                | Read | æ•°æ®è¯»å– | æ•°æ®åº“æŸ¥è¯¢ã€æ–‡ä»¶è¯»å– |
                | Write | æ•°æ®å†™å…¥ | æ•°æ®ä¿å­˜ã€çŠ¶æ€æ›´æ–° |
                
                ## é€‚ç”¨åœºæ™¯å¯¹æ¯”
                
                ### NESMAé€‚ç”¨åœºæ™¯
                **ä¼˜åŠ¿é¢†åŸŸ**:
                - ä¼ ç»Ÿä¼ä¸šåº”ç”¨
                - æ•°æ®å¤„ç†å¯†é›†å‹ç³»ç»Ÿ
                - æŠ¥è¡¨å’ŒæŸ¥è¯¢ä¸ºä¸»çš„åº”ç”¨
                - éœ€è¦è¯¦ç»†å¤æ‚åº¦åˆ†æçš„é¡¹ç›®
                
                **æŠ€æœ¯ç‰¹å¾**:
                - å…³ç³»å‹æ•°æ®åº“ä¸ºä¸»
                - ä¼ ç»Ÿä¸‰å±‚æ¶æ„
                - æ‰¹å¤„ç†ç³»ç»Ÿ
                - ä¼ä¸šèµ„æºè§„åˆ’(ERP)
                
                ### COSMICé€‚ç”¨åœºæ™¯
                **ä¼˜åŠ¿é¢†åŸŸ**:
                - ç°ä»£åˆ†å¸ƒå¼ç³»ç»Ÿ
                - é¢å‘æœåŠ¡æ¶æ„(SOA)
                - å¾®æœåŠ¡æ¶æ„
                - å®æ—¶å¤„ç†ç³»ç»Ÿ
                
                **æŠ€æœ¯ç‰¹å¾**:
                - APIé©±åŠ¨çš„æ¶æ„
                - äº‘åŸç”Ÿåº”ç”¨
                - ç§»åŠ¨åº”ç”¨
                - ç‰©è”ç½‘ç³»ç»Ÿ
                
                ## æµ‹é‡ç²¾åº¦å¯¹æ¯”
                
                ### NESMAç²¾åº¦ç‰¹ç‚¹
                **ç»†ç²’åº¦åˆ†æ**:
                - DET/RETè¯¦ç»†è®¡ç®—
                - å¤æ‚åº¦ç­‰çº§ç²¾ç¡®åˆ†ç±»
                - æƒé‡å·®å¼‚åæ˜ å¤æ‚åº¦
                
                **æ½œåœ¨åå·®**:
                - å¤æ‚åº¦è¯„ä¼°ä¸»è§‚æ€§
                - æƒé‡è¡¨å›ºå®šå¯èƒ½ä¸å‡†ç¡®
                - DET/RETè®¡ç®—å¤æ‚æ˜“é”™
                
                ### COSMICç²¾åº¦ç‰¹ç‚¹
                **ä¸€è‡´æ€§ä¼˜åŠ¿**:
                - ç­‰æƒé‡å‡å°‘ä¸»è§‚åˆ¤æ–­
                - æ•°æ®ç§»åŠ¨å®¢è§‚å¯è®¡æ•°
                - è¾¹ç•Œå®šä¹‰ç›¸å¯¹æ¸…æ™°
                
                **æ½œåœ¨é™åˆ¶**:
                - å¿½ç•¥å¤æ‚åº¦å·®å¼‚
                - ç²’åº¦é€‰æ‹©å½±å“ç»“æœ
                - è¾¹ç•Œè¯†åˆ«ä»éœ€ç»éªŒ
                
                ## å·¥ä½œé‡å¯¹æ¯”
                
                ### NESMAå·¥ä½œé‡
                **æ—¶é—´æŠ•å…¥**: ç›¸å¯¹è¾ƒé«˜
                **æŠ€èƒ½è¦æ±‚**: éœ€è¦NESMAä¸“ä¸šçŸ¥è¯†
                **æ–‡æ¡£è¦æ±‚**: è¯¦ç»†çš„DET/RETåˆ†æ
                **è´¨é‡ä¿è¯**: å¤šè½®å¤æ‚åº¦éªŒè¯
                
                ### COSMICå·¥ä½œé‡
                **æ—¶é—´æŠ•å…¥**: ç›¸å¯¹è¾ƒä½
                **æŠ€èƒ½è¦æ±‚**: éœ€è¦ç†è§£æ•°æ®æµ
                **æ–‡æ¡£è¦æ±‚**: åŠŸèƒ½è¿‡ç¨‹å’Œæ•°æ®ç§»åŠ¨
                **è´¨é‡ä¿è¯**: è¾¹ç•Œä¸€è‡´æ€§æ£€æŸ¥
                
                ## ç»“æœå¯æ¯”æ€§
                
                ### è½¬æ¢å…³ç³»ç ”ç©¶
                **ç»éªŒæ¯”ç‡**:
                - ä¸€èˆ¬æƒ…å†µ: 1 NESMA UFP â‰ˆ 1-1.2 COSMIC CFP
                - ç®€å•ç³»ç»Ÿ: æ¯”ç‡å¯èƒ½æ›´é«˜
                - å¤æ‚ç³»ç»Ÿ: æ¯”ç‡å¯èƒ½æ›´ä½
                
                **å½±å“å› ç´ **:
                - ç³»ç»Ÿå¤æ‚åº¦åˆ†å¸ƒ
                - æ•°æ®å¤„ç†å¯†åº¦
                - ç•Œé¢å¤æ‚ç¨‹åº¦
                - æŠ€æœ¯æ¶æ„å·®å¼‚
                
                ### å¯¹æ¯”åˆ†æå»ºè®®
                **åŒæ ‡å‡†é¡¹ç›®**:
                1. å…ˆç¡®å®šè¾¹ç•Œä¸€è‡´æ€§
                2. åˆ†åˆ«ç‹¬ç«‹æµ‹é‡
                3. åˆ†æå·®å¼‚åŸå› 
                4. å»ºç«‹é¡¹ç›®ç‰¹å®šæ¯”ç‡
                
                **ç»“æœéªŒè¯**:
                - 10%ä»¥å†…å·®å¼‚ï¼šæ­£å¸¸èŒƒå›´
                - 10-25%å·®å¼‚ï¼šéœ€åˆ†æåŸå› 
                - 25%ä»¥ä¸Šå·®å¼‚ï¼šé‡æ–°æ£€æŸ¥æµ‹é‡
                
                ## é€‰æ‹©å»ºè®®
                
                ### é€‰æ‹©NESMAçš„æƒ…å†µ
                - ä¼ ç»Ÿä¼ä¸šåº”ç”¨å¼€å‘
                - å›¢é˜Ÿç†Ÿæ‚‰NESMAæ–¹æ³•
                - éœ€è¦è¯¦ç»†å¤æ‚åº¦åˆ†æ
                - ä¸å†å²é¡¹ç›®å¯¹æ¯”
                
                ### é€‰æ‹©COSMICçš„æƒ…å†µ
                - ç°ä»£è½¯ä»¶æ¶æ„é¡¹ç›®
                - æ•æ·å¼€å‘ç¯å¢ƒ
                - åˆ†å¸ƒå¼ç³»ç»Ÿä¼°ç®—
                - å›½é™…æ ‡å‡†åŒ–è¦æ±‚
                
                ### åŒæ ‡å‡†çš„æƒ…å†µ
                - å¤§å‹å…³é”®é¡¹ç›®
                - ä¼°ç®—ç²¾åº¦è¦æ±‚æé«˜
                - å›¢é˜Ÿèƒ½åŠ›å……è¶³
                - æ—¶é—´èµ„æºå…è®¸
                """
            }
        ]
        
        return comparison_documents
    
    async def enhance_knowledge_base(self) -> Dict[str, Any]:
        """å¢å¼ºçŸ¥è¯†åº“"""
        
        logger.info("ğŸš€ å¼€å§‹å¢å¼ºçŸ¥è¯†åº“...")
        
        # åˆ›å»ºæ–‡æ¡£
        nesma_docs = await self.create_nesma_knowledge_documents()
        cosmic_docs = await self.create_cosmic_knowledge_documents()
        comparison_docs = await self.create_comparison_documents()
        
        all_documents = nesma_docs + cosmic_docs + comparison_docs
        
        # ä¿å­˜æ–‡æ¡£åˆ°æ–‡ä»¶
        docs_dir = Path("knowledge_base/documents")
        docs_dir.mkdir(parents=True, exist_ok=True)
        
        enhanced_docs = []
        
        for doc in all_documents:
            # åˆ†å‰²æ–‡æ¡£
            splits = self.text_splitter.split_text(doc["content"])
            
            for i, split in enumerate(splits):
                enhanced_doc = {
                    "title": f"{doc['title']} - ç¬¬{i+1}éƒ¨åˆ†",
                    "content": split,
                    "source_type": self._determine_source_type(doc["title"]),
                    "chunk_index": i,
                    "total_chunks": len(splits),
                    "created_at": datetime.now().isoformat()
                }
                enhanced_docs.append(enhanced_doc)
        
        # ä¿å­˜å¢å¼ºæ–‡æ¡£
        enhanced_file = docs_dir / "enhanced_knowledge.json"
        with open(enhanced_file, 'w', encoding='utf-8') as f:
            json.dump(enhanced_docs, f, ensure_ascii=False, indent=2)
        
        logger.info(f"âœ… ä¿å­˜äº† {len(enhanced_docs)} ä¸ªæ–‡æ¡£å—åˆ° {enhanced_file}")
        
        # åˆ›å»ºå‘é‡å­˜å‚¨ï¼ˆå¦‚æœé…ç½®äº†ï¼‰
        try:
            await self._create_vector_store(enhanced_docs)
        except Exception as e:
            logger.warning(f"å‘é‡å­˜å‚¨åˆ›å»ºå¤±è´¥: {e}")
        
        return {
            "total_documents": len(all_documents),
            "total_chunks": len(enhanced_docs),
            "nesma_documents": len(nesma_docs),
            "cosmic_documents": len(cosmic_docs),
            "comparison_documents": len(comparison_docs),
            "saved_to": str(enhanced_file)
        }
    
    def _determine_source_type(self, title: str) -> str:
        """ç¡®å®šæ–‡æ¡£æ¥æºç±»å‹"""
        if "NESMA" in title:
            return "NESMA"
        elif "COSMIC" in title:
            return "COSMIC"
        elif "å¯¹æ¯”" in title or "vs" in title:
            return "COMPARISON"
        else:
            return "COMMON"
    
    async def _create_vector_store(self, documents: List[Dict[str, Any]]) -> None:
        """åˆ›å»ºå‘é‡å­˜å‚¨"""
        
        logger.info("ğŸ“Š åˆ›å»ºå‘é‡å­˜å‚¨...")
        
        # å‡†å¤‡æ–‡æ¡£å†…å®¹
        texts = [doc["content"] for doc in documents]
        metadatas = [
            {
                "title": doc["title"],
                "source_type": doc["source_type"],
                "chunk_index": doc["chunk_index"],
                "created_at": doc["created_at"]
            }
            for doc in documents
        ]
        
        # åˆ›å»ºChromaå‘é‡å­˜å‚¨ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
        try:
            vectorstore = Chroma.from_texts(
                texts=texts,
                embedding=self.embeddings,
                metadatas=metadatas,
                persist_directory="./chroma_db_enhanced"
            )
            logger.info("âœ… Chromaå‘é‡å­˜å‚¨åˆ›å»ºæˆåŠŸ")
        except Exception as e:
            logger.error(f"Chromaå‘é‡å­˜å‚¨åˆ›å»ºå¤±è´¥: {e}")


async def main():
    """ä¸»å‡½æ•°"""
    
    enhancer = KnowledgeBaseEnhancer()
    
    try:
        result = await enhancer.enhance_knowledge_base()
        
        print("ğŸ‰ çŸ¥è¯†åº“å¢å¼ºå®Œæˆ!")
        print(f"æ€»æ–‡æ¡£æ•°: {result['total_documents']}")
        print(f"æ€»å—æ•°: {result['total_chunks']}")
        print(f"NESMAæ–‡æ¡£: {result['nesma_documents']}")
        print(f"COSMICæ–‡æ¡£: {result['cosmic_documents']}")
        print(f"å¯¹æ¯”æ–‡æ¡£: {result['comparison_documents']}")
        print(f"ä¿å­˜ä½ç½®: {result['saved_to']}")
        
    except Exception as e:
        logger.error(f"çŸ¥è¯†åº“å¢å¼ºå¤±è´¥: {e}")
        raise


if __name__ == "__main__":
    asyncio.run(main()) 